<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Openresty">
<meta property="og:type" content="article">
<meta property="og:title" content="Openresty">
<meta property="og:url" content="http://example.com/2024/02/19/Openresty/index.html">
<meta property="og:site_name" content="随笔">
<meta property="og:description" content="Openresty">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-02-19T08:33:07.000Z">
<meta property="article:modified_time" content="2024-02-19T08:34:34.896Z">
<meta property="article:author" content="Bling">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/2024/02/19/Openresty/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Openresty | 随笔</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">随笔</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/02/19/Openresty/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Bling">
      <meta itemprop="description" content="绳锯木断，水滴石穿">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随笔">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Openresty
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-02-19 16:33:07 / 修改时间：16:34:34" itemprop="dateCreated datePublished" datetime="2024-02-19T16:33:07+08:00">2024-02-19</time>
            </span>

          
            <div class="post-description">Openresty</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><h2 id="源码安装"><a href="#源码安装" class="headerlink" title="源码安装"></a>源码安装</h2><ul>
<li><p>查看 Linux 内核版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># method 1</span></span><br><span class="line"><span class="built_in">cat</span> /proc/version</span><br><span class="line"><span class="comment"># method 2</span></span><br><span class="line"><span class="built_in">uname</span> -a</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看 Linux 系统版本命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># method 1，适用于所有的 Linux 发行版</span></span><br><span class="line">lsb_release -a</span><br><span class="line"><span class="comment"># method 2，适用于所有的 Linux 发行版</span></span><br><span class="line"><span class="built_in">cat</span> /etc/issue</span><br><span class="line"><span class="comment"># 只适合 Redhat 系的 Linux</span></span><br><span class="line"><span class="built_in">cat</span> /etc/redhat-release</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装前的准备</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install libpcre3-dev libssl-dev perl make build-essential curl</span><br></pre></td></tr></table></figure>
</li>
<li><p>下载源码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># openresty</span></span><br><span class="line">wget https://openresty.org/download/openresty-1.21.4.2.tar.gz</span><br><span class="line"><span class="comment"># luajit</span></span><br><span class="line">wget https://luajit.org/download/LuaJIT-2.0.5.tar.gz</span><br><span class="line"><span class="comment"># ngx_cache_purge，用于清理 nginx 缓存</span></span><br><span class="line">wget http://labs.frickle.com/files/ngx_cache_purge-2.3.tar.gz</span><br><span class="line"><span class="comment"># nginx_upstream_check_module，用于 upstream 健康检查</span></span><br><span class="line">wget https://github.com/yaoweibin/nginx_upstream_check_module/archive/refs/tags/v0.4.0.tar.gz</span><br></pre></td></tr></table></figure>
</li>
<li><p>编译安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># luajit</span></span><br><span class="line">tar -xzvf LuaJIT-2.0.5.tar.gz</span><br><span class="line"><span class="built_in">cd</span> LuaJIT-2.0.5</span><br><span class="line"><span class="comment"># 默认在 /usr/local 下</span></span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># ngx_cache_purge</span></span><br><span class="line">tar -xzvf ngx_cache_purge-2.3.tar.gz </span><br><span class="line"></span><br><span class="line"><span class="comment"># nginx_upstream_check_module</span></span><br><span class="line">tar -xzvf v0.4.0.tar.gz</span><br><span class="line"></span><br><span class="line">tar -xzvf openresty-1.21.4.2.tar.gz</span><br><span class="line"><span class="built_in">cd</span> openresty-1.21.4.2</span><br><span class="line"><span class="comment"># 默认安装到 /usr/local/openresty</span></span><br><span class="line">./configure --with-http_realip_module --with-luajit --with-pcre --add-module=../ngx_cache_purge-2.3 --add-module=../nginx_upstream_check_module-0.4.0</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
</li>
<li><p>systemd 管理 openresty</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">touch</span> /usr/lib/systemd/system/openresty.service</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=The OpenResty Application Platform</span><br><span class="line">After=syslog.target network-online.target remote-fs.target nss-lookup.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">PIDFile=/usr/local/openresty/nginx/logs/nginx.pid</span><br><span class="line">ExecStartPre=/usr/local/openresty/nginx/sbin/nginx -t -q -g &#x27;daemon on; master_process on;&#x27;</span><br><span class="line">ExecStart=/usr/local/openresty/nginx/sbin/nginx -g &#x27;daemon on; master_process on;&#x27;</span><br><span class="line">ExecReload=/usr/local/openresty/nginx/sbin/nginx -g &#x27;daemon on; master_process on;&#x27; -s reload</span><br><span class="line">ExecStop=/sbin/start-stop-daemon --quiet --stop --retry QUIT/5 --pidfile /usr/local/openresty/nginx/logs/nginx.pid</span><br><span class="line">TimeoutStopSec=5</span><br><span class="line">KillMode=mixed</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start openresty</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Type=forking</code> 表示 <code>ExecStart=</code> 进程将会在启动过程中使用 <code>fork()</code> 系统调用，即当启动完成后，父进程会退出，而子进程将作为主服务进程继续运行</li>
</ul>
</li>
</ul>
<h2 id="相关包"><a href="#相关包" class="headerlink" title="相关包"></a>相关包</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/tokers/lua-resty-ctxdump#stash_ngx_ctx">lua-resty-ctxdump</a>：对 ngx.tx 进行 stash，防止因 Nginx 内部重定向导致 ctx 丢失<ul>
<li>主要函数两个：<code>stash_ngx_ctx</code> 和 <code>apply_ngx_ctx</code>，必须成对被调用，否则会造成内存泄漏</li>
</ul>
</li>
</ul>
<h2 id="Ngx-log"><a href="#Ngx-log" class="headerlink" title="Ngx.log"></a>Ngx.log</h2><ul>
<li><p><code>openresty-version/bundle/nginx-version/src/http/ngx_http_request.c</code></p>
<ul>
<li><code>ngx_http_log_error</code><ul>
<li><code>, client: %V</code></li>
<li><code>, server: %V</code></li>
<li><code>, request: &#39;%V&#39;</code></li>
<li><code>, subrequest: &#39;%V&#39;</code></li>
<li><code>, upstream: &#39;&#123;schema&#125;&#123;peer_name&#125;&#123;uri_separator&#125;&#123;uri&#125;&#39;</code></li>
<li><code>, host: &#39;&#123;headers_in.host.value&#125;&#39;</code></li>
<li><code>, referrer: &#39;&#123;headers_in.referer.value&#125;&#39;</code></li>
</ul>
</li>
</ul>
</li>
<li><p><code>openresty-version/bundle/nginx-version/src/mail/ngx_mail_handler.c</code></p>
<ul>
<li><code>ngx_mail_log_error</code><ul>
<li><code>, client: %V</code></li>
<li><code>, server: %V</code></li>
<li><code>, login: &#39;%V&#39;</code></li>
<li><code>, upstream: %V</code></li>
</ul>
</li>
</ul>
</li>
<li><p><code>openresty-version/bundle/nginx-version/src/stream/ngx_stream_handler.c</code></p>
<ul>
<li><code>ngx_stream_log_error</code><ul>
<li><code>, udp client: %V, server: %V</code></li>
<li><code>, client: %V, server: %V</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="core-ngx-log-h-头文件分析"><a href="#core-ngx-log-h-头文件分析" class="headerlink" title="core&#x2F;ngx_log.h 头文件分析"></a>core&#x2F;ngx_log.h 头文件分析</h1><blockquote>
<p>以下代码源于：openresty-version&#x2F;bundle&#x2F;nginx-version&#x2F;src&#x2F;core&#x2F;ngx_log.h</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _NGX_LOG_H_INCLUDED_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _NGX_LOG_H_INCLUDED_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ngx_config.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ngx_core.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 日志打印级别中的大级别，4 bit 表示，每个日志级别只能属于其中的一个</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NGX_LOG_STDERR            0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NGX_LOG_EMERG             1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NGX_LOG_ALERT             2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NGX_LOG_CRIT              3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NGX_LOG_ERR               4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NGX_LOG_WARN              5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NGX_LOG_NOTICE            6</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NGX_LOG_INFO              7</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NGX_LOG_DEBUG             8</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// debug 级别中的小级别，7 bit 表示，可以同时存在多个</span></span><br><span class="line"><span class="comment">// 如果日志级别为 NGX_LOG_DEBUG，则包含所有 debug 级别中的小级别，此时 log_level 会被直接设置为 NGX_LOG_DEBUG_ALL</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NGX_LOG_DEBUG_CORE        0x010</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NGX_LOG_DEBUG_ALLOC       0x020</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NGX_LOG_DEBUG_MUTEX       0x040</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NGX_LOG_DEBUG_EVENT       0x080</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NGX_LOG_DEBUG_HTTP        0x100</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NGX_LOG_DEBUG_MAIL        0x200</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NGX_LOG_DEBUG_STREAM      0x400</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加一个新的 debug 级别后需要更新 src/core/ngx_log.c 中的 debug_levels[]</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NGX_LOG_DEBUG_FIRST       NGX_LOG_DEBUG_CORE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NGX_LOG_DEBUG_LAST        NGX_LOG_DEBUG_STREAM</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NGX_LOG_DEBUG_CONNECTION  0x80000000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NGX_LOG_DEBUG_ALL         0x7ffffff0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> u_char *(*ngx_log_handler_pt) (<span class="type">ngx_log_t</span> *<span class="built_in">log</span>, u_char *buf, <span class="type">size_t</span> len);</span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">void</span> <span class="params">(*ngx_log_writer_pt)</span> <span class="params">(<span class="type">ngx_log_t</span> *<span class="built_in">log</span>, <span class="type">ngx_uint_t</span> level, u_char *buf, <span class="type">size_t</span> len)</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_log_s</span> &#123;</span></span><br><span class="line">    <span class="type">ngx_uint_t</span>           log_level;      <span class="comment">// 当前的日志打印级别</span></span><br><span class="line">    <span class="type">ngx_open_file_t</span>     *file;           <span class="comment">// 当前日志对象所关联的文件</span></span><br><span class="line">    <span class="type">ngx_atomic_uint_t</span>    connection;     <span class="comment">// 当前引用该日志对象的连接数</span></span><br><span class="line">    <span class="type">time_t</span>               disk_full_time; <span class="comment">// 日志硬盘满的时间</span></span><br><span class="line">    ngx_log_handler_pt   handler;        <span class="comment">// 日志信息处理器（一般是对日志进行格式化）</span></span><br><span class="line">    <span class="type">void</span>                *data;           <span class="comment">// 一般作为日志信息处理的一个上下文对象</span></span><br><span class="line">    ngx_log_writer_pt    writer;         <span class="comment">// 进行日志写操作处理器</span></span><br><span class="line">    <span class="type">void</span>                *wdata;          <span class="comment">// 作为日志写操作处理器的一个上下文对象</span></span><br><span class="line">    <span class="comment">// 之所以声明为 char * 是因为 actions 通常为静态字符串，在 uchar * 情况下需要始终 override 它们的类型</span></span><br><span class="line">    <span class="type">char</span>                *action;         <span class="comment">// 写日志前所执行的操作</span></span><br><span class="line">    <span class="type">ngx_log_t</span>           *next;           <span class="comment">// 指向下一个日志对象</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 单条日志的最大长度</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> NGX_MAX_ERROR_STR</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NGX_MAX_ERROR_STR   4096</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*********************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 定义了三个函数</span></span><br><span class="line"><span class="comment"> * ngx_log_error(): 打印一般的错误日志消息</span></span><br><span class="line"><span class="comment"> * ngx_log_error_core(): 打印日志的核心函数</span></span><br><span class="line"><span class="comment"> * ngx_log_debug_core(): 打印 debug 级别日志的函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 支持 C99 可变参数宏定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> (NGX_HAVE_C99_VARIADIC_MACROS)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NGX_HAVE_VARIADIC_MACROS  1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ngx_log_error(level, log, ...) <span class="keyword">if</span> ((log)-&gt;log_level &gt;= level) ngx_log_error_core(level, log, __VA_ARGS__)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ngx_log_error_core</span><span class="params">(<span class="type">ngx_uint_t</span> level, <span class="type">ngx_log_t</span> *<span class="built_in">log</span>, <span class="type">ngx_err_t</span> err, <span class="type">const</span> <span class="type">char</span> *fmt, ...)</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ngx_log_debug(level, log, ...) <span class="keyword">if</span> ((log)-&gt;log_level &amp; level) ngx_log_error_core(NGX_LOG_DEBUG, log, __VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 支持 gcc 可变参数宏定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> (NGX_HAVE_GCC_VARIADIC_MACROS)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NGX_HAVE_VARIADIC_MACROS  1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ngx_log_error(level, log, args...) <span class="keyword">if</span> ((log)-&gt;log_level &gt;= level) ngx_log_error_core(level, log, args)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ngx_log_error_core</span><span class="params">(<span class="type">ngx_uint_t</span> level, <span class="type">ngx_log_t</span> *<span class="built_in">log</span>, <span class="type">ngx_err_t</span> err, <span class="type">const</span> <span class="type">char</span> *fmt, ...)</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ngx_log_debug(level, log, args...) <span class="keyword">if</span> ((log)-&gt;log_level &amp; level) ngx_log_error_core(NGX_LOG_DEBUG, log, args)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">else</span> <span class="comment">/* no variadic macros */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NGX_HAVE_VARIADIC_MACROS  0</span></span><br><span class="line"><span class="type">void</span> ngx_cdecl <span class="title function_">ngx_log_error</span><span class="params">(<span class="type">ngx_uint_t</span> level, <span class="type">ngx_log_t</span> *<span class="built_in">log</span>, <span class="type">ngx_err_t</span> err, <span class="type">const</span> <span class="type">char</span> *fmt, ...)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">ngx_log_error_core</span><span class="params">(<span class="type">ngx_uint_t</span> level, <span class="type">ngx_log_t</span> *<span class="built_in">log</span>, <span class="type">ngx_err_t</span> err, <span class="type">const</span> <span class="type">char</span> *fmt, va_list args)</span>;</span><br><span class="line"><span class="type">void</span> ngx_cdecl <span class="title function_">ngx_log_debug_core</span><span class="params">(<span class="type">ngx_log_t</span> *<span class="built_in">log</span>, <span class="type">ngx_err_t</span> err, <span class="type">const</span> <span class="type">char</span> *fmt, ...)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* variadic macros */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*********************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ngx_log_debug 辅助函数</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> (NGX_DEBUG)</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> (NGX_HAVE_VARIADIC_MACROS)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ngx_log_debug0(level, log, err, fmt) ngx_log_debug(level, log, err, fmt)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ngx_log_debug1(level, log, err, fmt, arg1) ngx_log_debug(level, log, err, fmt, arg1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ngx_log_debug2(level, log, err, fmt, arg1, arg2) ngx_log_debug(level, log, err, fmt, arg1, arg2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ngx_log_debug3(level, log, err, fmt, arg1, arg2, arg3) ngx_log_debug(level, log, err, fmt, arg1, arg2, arg3)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ngx_log_debug4(level, log, err, fmt, arg1, arg2, arg3, arg4) \</span></span><br><span class="line"><span class="meta">				ngx_log_debug(level, log, err, fmt, arg1, arg2, arg3, arg4)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ngx_log_debug5(level, log, err, fmt, arg1, arg2, arg3, arg4, arg5) \</span></span><br><span class="line"><span class="meta">				ngx_log_debug(level, log, err, fmt, arg1, arg2, arg3, arg4, arg5)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ngx_log_debug6(level, log, err, fmt, arg1, arg2, arg3, arg4, arg5, arg6) \</span></span><br><span class="line"><span class="meta">        ngx_log_debug(level, log, err, fmt, arg1, arg2, arg3, arg4, arg5, arg6)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ngx_log_debug7(level, log, err, fmt, arg1, arg2, arg3, arg4, arg5, arg6, arg7) \</span></span><br><span class="line"><span class="meta">        ngx_log_debug(level, log, err, fmt, arg1, arg2, arg3, arg4, arg5, arg6, arg7)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ngx_log_debug8(level, log, err, fmt, arg1, arg2, arg3, arg4, arg5, arg6, arg7, arg8) \</span></span><br><span class="line"><span class="meta">        ngx_log_debug(level, log, err, fmt, arg1, arg2, arg3, arg4, arg5, arg6, arg7, arg8)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">else</span> <span class="comment">/* no variadic macros */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ngx_log_debug0(level, log, err, fmt) <span class="keyword">if</span> ((log)-&gt;log_level &amp; level) ngx_log_debug_core(log, err, fmt)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ngx_log_debug1(level, log, err, fmt, arg1) <span class="keyword">if</span> ((log)-&gt;log_level &amp; level) ngx_log_debug_core(log, err, fmt, arg1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ngx_log_debug2(level, log, err, fmt, arg1, arg2) \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> ((log)-&gt;log_level &amp; level) ngx_log_debug_core(log, err, fmt, arg1, arg2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ngx_log_debug3(level, log, err, fmt, arg1, arg2, arg3) \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> ((log)-&gt;log_level &amp; level) ngx_log_debug_core(log, err, fmt, arg1, arg2, arg3)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ngx_log_debug4(level, log, err, fmt, arg1, arg2, arg3, arg4) \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> ((log)-&gt;log_level &amp; level) ngx_log_debug_core(log, err, fmt, arg1, arg2, arg3, arg4)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ngx_log_debug5(level, log, err, fmt, arg1, arg2, arg3, arg4, arg5) \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> ((log)-&gt;log_level &amp; level) ngx_log_debug_core(log, err, fmt, arg1, arg2, arg3, arg4, arg5)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ngx_log_debug6(level, log, err, fmt, arg1, arg2, arg3, arg4, arg5, arg6) \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> ((log)-&gt;log_level &amp; level) ngx_log_debug_core(log, err, fmt, arg1, arg2, arg3, arg4, arg5, arg6)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ngx_log_debug7(level, log, err, fmt, arg1, arg2, arg3, arg4, arg5, arg6, arg7) \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> ((log)-&gt;log_level &amp; level) ngx_log_debug_core(log, err, fmt, arg1, arg2, arg3, arg4, arg5, arg6, arg7)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ngx_log_debug8(level, log, err, fmt, arg1, arg2, arg3, arg4, arg5, arg6, arg7, arg8) \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> ((log)-&gt;log_level &amp; level) ngx_log_debug_core(log, err, fmt, arg1, arg2, arg3, arg4, arg5, arg6, arg7, arg8)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">else</span> <span class="comment">/* !NGX_DEBUG */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ngx_log_debug0(level, log, err, fmt)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ngx_log_debug1(level, log, err, fmt, arg1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ngx_log_debug2(level, log, err, fmt, arg1, arg2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ngx_log_debug3(level, log, err, fmt, arg1, arg2, arg3)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ngx_log_debug4(level, log, err, fmt, arg1, arg2, arg3, arg4)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ngx_log_debug5(level, log, err, fmt, arg1, arg2, arg3, arg4, arg5)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ngx_log_debug6(level, log, err, fmt, arg1, arg2, arg3, arg4, arg5, arg6)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ngx_log_debug7(level, log, err, fmt, arg1, arg2, arg3, arg4, arg5, arg6, arg7)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ngx_log_debug8(level, log, err, fmt, arg1, arg2, arg3, arg4, arg5, arg6, arg7, arg8)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*********************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 相关函数声明</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// nginx 日志初始化</span></span><br><span class="line"><span class="type">ngx_log_t</span> *<span class="title function_">ngx_log_init</span><span class="params">(u_char *prefix, u_char *error_log)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印 alert 级别日志</span></span><br><span class="line"><span class="type">void</span> ngx_cdecl <span class="title function_">ngx_log_abort</span><span class="params">(<span class="type">ngx_err_t</span> err, <span class="type">const</span> <span class="type">char</span> *fmt, ...)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将相应的日志信息打印到标准输出</span></span><br><span class="line"><span class="type">void</span> ngx_cdecl <span class="title function_">ngx_log_stderr</span><span class="params">(<span class="type">ngx_err_t</span> err, <span class="type">const</span> <span class="type">char</span> *fmt, ...)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印 errno 日志，注意此函数值至少保证有 50 个字节的空间来打印 errno 日志</span></span><br><span class="line">u_char *<span class="title function_">ngx_log_errno</span><span class="params">(u_char *buf, u_char *last, <span class="type">ngx_err_t</span> err)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打开默认日志文件</span></span><br><span class="line"><span class="type">ngx_int_t</span> <span class="title function_">ngx_log_open_default</span><span class="params">(<span class="type">ngx_cycle_t</span> *cycle)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重定向标准错误。即将标准错误输出重定向到某一个日志文件</span></span><br><span class="line"><span class="type">ngx_int_t</span> <span class="title function_">ngx_log_redirect_stderr</span><span class="params">(<span class="type">ngx_cycle_t</span> *cycle)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获得一个文件日志对象</span></span><br><span class="line"><span class="type">ngx_log_t</span> *<span class="title function_">ngx_log_get_file_log</span><span class="params">(<span class="type">ngx_log_t</span> *head)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据 ngx_conf_t 设置日志对象</span></span><br><span class="line"><span class="type">char</span> *<span class="title function_">ngx_log_set_log</span><span class="params">(<span class="type">ngx_conf_t</span> *cf, <span class="type">ngx_log_t</span> **head)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 相关静态函数定义</span></span><br><span class="line"><span class="comment">// ngx_write_stder() 不能实现为宏是因为 MSVC 不允许在宏参数中使用 #ifdef</span></span><br><span class="line"><span class="comment">// ngx_write_fd() 替换了 ngx_write_console() 是因为 ngx_write_console() 中的 CharToOemBuff() 不能与只读缓冲区作为目标使用，且 ngx_write_stder() 不再需要 CharToOemBuff()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 将 text 输出到标准错误中</span></span><br><span class="line"><span class="type">static</span> ngx_inline <span class="type">void</span></span><br><span class="line"><span class="title function_">ngx_write_stderr</span><span class="params">(<span class="type">char</span> *text)</span> &#123;</span><br><span class="line">    (<span class="type">void</span>) ngx_write_fd(ngx_stderr, text, ngx_strlen(text));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将 text 输出到标准输出中</span></span><br><span class="line"><span class="type">static</span> ngx_inline <span class="type">void</span></span><br><span class="line"><span class="title function_">ngx_write_stdout</span><span class="params">(<span class="type">char</span> *text)</span> &#123;</span><br><span class="line">    (<span class="type">void</span>) ngx_write_fd(ngx_stdout, text, ngx_strlen(text));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 相关变量声明</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// errlog 模块相应数据结构变量</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">ngx_module_t</span>  ngx_errlog_module;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 主要用于控制是否输出到标准错误，一般 Nginx 启动时会设置为 1</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">ngx_uint_t</span>    ngx_use_stderr;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* _NGX_LOG_H_INCLUDED_ */</span></span></span><br></pre></td></tr></table></figure>



<h1 id="core-ngx-log-c-源文件分析"><a href="#core-ngx-log-c-源文件分析" class="headerlink" title="core&#x2F;ngx_log.c 源文件分析"></a>core&#x2F;ngx_log.c 源文件分析</h1><blockquote>
<p>以下代码源于：openresty-version&#x2F;bundle&#x2F;nginx-version&#x2F;src&#x2F;core&#x2F;ngx_log.c</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ngx_config.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ngx_core.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析 error_log 指令时相应的处理函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> *<span class="title function_">ngx_error_log</span><span class="params">(<span class="type">ngx_conf_t</span> *cf, <span class="type">ngx_command_t</span> *cmd, <span class="type">void</span> *conf)</span>;</span><br><span class="line"><span class="comment">// 设置日志级别</span></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> *<span class="title function_">ngx_log_set_levels</span><span class="params">(<span class="type">ngx_conf_t</span> *cf, <span class="type">ngx_log_t</span> *<span class="built_in">log</span>)</span>;</span><br><span class="line"><span class="comment">// 将 new_log 插入到 log 链表中，log 链表是按 log-&gt;log_level 从大到小的顺序排列的</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ngx_log_insert</span><span class="params">(<span class="type">ngx_log_t</span> *<span class="built_in">log</span>, <span class="type">ngx_log_t</span> *new_log)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> (NGX_DEBUG)</span></span><br><span class="line"><span class="comment">// NGX_DEBUG 条件下使用，主要用于在调试环境下将 buf 数据写到内存中</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ngx_log_memory_writer</span><span class="params">(<span class="type">ngx_log_t</span> *<span class="built_in">log</span>, <span class="type">ngx_uint_t</span> level, u_char *buf, <span class="type">size_t</span> len)</span>;</span><br><span class="line"><span class="comment">// NGX_DEBUG 条件下使用，主要用于清除内存 buf</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ngx_log_memory_cleanup</span><span class="params">(<span class="type">void</span> *data)</span>;</span><br><span class="line"><span class="comment">// NGX_DEBUG 条件下使用，用于在内存中保存日志的 buf，是一个循环 buffer 内存</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    u_char *start;        <span class="comment">// 该内存Buff的开始位置</span></span><br><span class="line">    u_char *end;          <span class="comment">// 该内存buff的结束位置</span></span><br><span class="line">    u_char *pos;          <span class="comment">// 实际写日志的起始位置，这是因为在 start 后会插入一些相应的内存日志的提示信息</span></span><br><span class="line">    <span class="type">ngx_atomic_t</span> written; <span class="comment">// 当前总共写了多少日志数据</span></span><br><span class="line">&#125; <span class="type">ngx_log_memory_buf_t</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义 ngx_errlog_module 模块对于的指令</span></span><br><span class="line"><span class="type">static</span> <span class="type">ngx_command_t</span> ngx_errlog_commands[] = &#123;</span><br><span class="line">    &#123;ngx_string(<span class="string">&quot;error_log&quot;</span>),</span><br><span class="line">     NGX_MAIN_CONF | NGX_CONF_1MORE,</span><br><span class="line">     ngx_error_log,</span><br><span class="line">     <span class="number">0</span>,</span><br><span class="line">     <span class="number">0</span>,</span><br><span class="line">     <span class="literal">NULL</span>&#125;,</span><br><span class="line">    ngx_null_command&#125;;</span><br><span class="line"><span class="comment">// 定义 ngx_errlog_module 模块对于的上下文</span></span><br><span class="line"><span class="type">static</span> <span class="type">ngx_core_module_t</span> ngx_errlog_module_ctx = &#123;</span><br><span class="line">    ngx_string(<span class="string">&quot;errlog&quot;</span>),</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义 error_log 模块 ngx_errlog_module</span></span><br><span class="line"><span class="type">ngx_module_t</span> ngx_errlog_module = &#123;</span><br><span class="line">    NGX_MODULE_V1,</span><br><span class="line">    &amp;ngx_errlog_module_ctx, <span class="comment">/* module context */</span></span><br><span class="line">    ngx_errlog_commands,    <span class="comment">/* module directives */</span></span><br><span class="line">    NGX_CORE_MODULE,        <span class="comment">/* module type */</span></span><br><span class="line">    <span class="literal">NULL</span>,                   <span class="comment">/* init master */</span></span><br><span class="line">    <span class="literal">NULL</span>,                   <span class="comment">/* init module */</span></span><br><span class="line">    <span class="literal">NULL</span>,                   <span class="comment">/* init process */</span></span><br><span class="line">    <span class="literal">NULL</span>,                   <span class="comment">/* init thread */</span></span><br><span class="line">    <span class="literal">NULL</span>,                   <span class="comment">/* exit thread */</span></span><br><span class="line">    <span class="literal">NULL</span>,                   <span class="comment">/* exit process */</span></span><br><span class="line">    <span class="literal">NULL</span>,                   <span class="comment">/* exit master */</span></span><br><span class="line">    NGX_MODULE_V1_PADDING&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// nginx 中初始 log 对象</span></span><br><span class="line"><span class="type">static</span> <span class="type">ngx_log_t</span> ngx_log;</span><br><span class="line"><span class="comment">// nginx 初始 log 对象所关联的日志文件对象</span></span><br><span class="line"><span class="type">static</span> <span class="type">ngx_open_file_t</span> ngx_log_file;</span><br><span class="line"><span class="comment">// 表明是否使用 stderr 标准错误作为日志对象的输出位置</span></span><br><span class="line"><span class="type">ngx_uint_t</span> ngx_use_stderr = <span class="number">1</span>;</span><br><span class="line"><span class="comment">// 定义日志错误级别</span></span><br><span class="line"><span class="type">static</span> <span class="type">ngx_str_t</span> err_levels[] = &#123;</span><br><span class="line">    ngx_null_string,</span><br><span class="line">    ngx_string(<span class="string">&quot;emerg&quot;</span>),</span><br><span class="line">    ngx_string(<span class="string">&quot;alert&quot;</span>),</span><br><span class="line">    ngx_string(<span class="string">&quot;crit&quot;</span>),</span><br><span class="line">    ngx_string(<span class="string">&quot;error&quot;</span>),</span><br><span class="line">    ngx_string(<span class="string">&quot;warn&quot;</span>),</span><br><span class="line">    ngx_string(<span class="string">&quot;notice&quot;</span>),</span><br><span class="line">    ngx_string(<span class="string">&quot;info&quot;</span>),</span><br><span class="line">    ngx_string(<span class="string">&quot;debug&quot;</span>)&#125;;</span><br><span class="line"><span class="comment">// 定义 debug 级别</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> *debug_levels[] = &#123;</span><br><span class="line">    <span class="string">&quot;debug_core&quot;</span>, <span class="string">&quot;debug_alloc&quot;</span>, <span class="string">&quot;debug_mutex&quot;</span>, <span class="string">&quot;debug_event&quot;</span>, <span class="string">&quot;debug_http&quot;</span>, <span class="string">&quot;debug_mail&quot;</span>, <span class="string">&quot;debug_stream&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> (NGX_HAVE_VARIADIC_MACROS)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ngx_log_error_core</span><span class="params">(<span class="type">ngx_uint_t</span> level, <span class="type">ngx_log_t</span> *<span class="built_in">log</span>, <span class="type">ngx_err_t</span> err, <span class="type">const</span> <span class="type">char</span> *fmt, ...)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ngx_log_error_core</span><span class="params">(<span class="type">ngx_uint_t</span> level, <span class="type">ngx_log_t</span> *<span class="built_in">log</span>, <span class="type">ngx_err_t</span> err, <span class="type">const</span> <span class="type">char</span> *fmt, va_list args)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> (NGX_HAVE_VARIADIC_MACROS)</span></span><br><span class="line">    va_list args;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    u_char *p, *last, *msg;</span><br><span class="line">    <span class="type">ssize_t</span> n;</span><br><span class="line">    <span class="type">ngx_uint_t</span> wrote_stderr, debug_connection;</span><br><span class="line">    u_char errstr[NGX_MAX_ERROR_STR];</span><br><span class="line"></span><br><span class="line">    ngx_log_intercept_pt log_intercept = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    last = errstr + NGX_MAX_ERROR_STR;</span><br><span class="line">    <span class="comment">// 存入缓存的日志时间</span></span><br><span class="line">    p = ngx_cpymem(errstr, ngx_cached_err_log_time.data, ngx_cached_err_log_time.len);</span><br><span class="line">    <span class="comment">// 格式化并存入日志级别</span></span><br><span class="line">    p = ngx_slprintf(p, last, <span class="string">&quot; [%V] &quot;</span>, &amp;err_levels[level]);</span><br><span class="line">    <span class="comment">// 存入进程ID（pid）和线程ID（tid），格式为：pid#tid</span></span><br><span class="line">    p = ngx_slprintf(p, last, <span class="string">&quot;%P#&quot;</span> NGX_TID_T_FMT <span class="string">&quot;: &quot;</span>, ngx_log_pid, ngx_log_tid);</span><br><span class="line">    <span class="comment">// 格式化并存入当前引用该 log 的 connection 数目</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">log</span>-&gt;connection)</span><br><span class="line">    &#123;</span><br><span class="line">        p = ngx_slprintf(p, last, <span class="string">&quot;*%uA &quot;</span>, <span class="built_in">log</span>-&gt;connection);</span><br><span class="line">    &#125;</span><br><span class="line">    msg = p;</span><br><span class="line"><span class="comment">// 格式化函数传递进来的参数</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> (NGX_HAVE_VARIADIC_MACROS)</span></span><br><span class="line">    va_start(args, fmt);</span><br><span class="line">    p = ngx_vslprintf(p, last, fmt, args);</span><br><span class="line">    va_end(args);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    p = ngx_vslprintf(p, last, fmt, args);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="keyword">if</span> (err)</span><br><span class="line">    &#123;</span><br><span class="line">        p = ngx_log_errno(p, last, err);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (level != NGX_LOG_DEBUG &amp;&amp; <span class="built_in">log</span>-&gt;handler)</span><br><span class="line">    &#123;</span><br><span class="line">        p = <span class="built_in">log</span>-&gt;handler(<span class="built_in">log</span>, p, last - p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (p &gt; last - NGX_LINEFEED_SIZE)</span><br><span class="line">    &#123;</span><br><span class="line">        p = last - NGX_LINEFEED_SIZE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_cycle)</span><br><span class="line">    &#123;</span><br><span class="line">        log_intercept = ngx_cycle-&gt;intercept_error_log_handler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (log_intercept &amp;&amp; !ngx_cycle-&gt;entered_logger)</span><br><span class="line">    &#123;</span><br><span class="line">        ngx_cycle-&gt;entered_logger = <span class="number">1</span>;</span><br><span class="line">        log_intercept(<span class="built_in">log</span>, level, errstr, p - errstr);</span><br><span class="line">        ngx_cycle-&gt;entered_logger = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 换行</span></span><br><span class="line">    ngx_linefeed(p);</span><br><span class="line"></span><br><span class="line">    wrote_stderr = <span class="number">0</span>;</span><br><span class="line">    debug_connection = (<span class="built_in">log</span>-&gt;log_level &amp; NGX_LOG_DEBUG_CONNECTION) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 循环遍历 log 链，将日志输出到 log-&gt;fd</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">log</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">log</span>-&gt;log_level &lt; level &amp;&amp; !debug_connection)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">log</span>-&gt;writer)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log</span>-&gt;writer(<span class="built_in">log</span>, level, errstr, p - errstr);</span><br><span class="line">            <span class="keyword">goto</span> next;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_time() == <span class="built_in">log</span>-&gt;disk_full_time)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * on FreeBSD writing to a full filesystem with enabled softupdates</span></span><br><span class="line"><span class="comment">             * may block process for much longer time than writing to non-full</span></span><br><span class="line"><span class="comment">             * filesystem, so we skip writing to a log for one second</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">goto</span> next;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        n = ngx_write_fd(<span class="built_in">log</span>-&gt;file-&gt;fd, errstr, p - errstr);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (n == <span class="number">-1</span> &amp;&amp; ngx_errno == NGX_ENOSPC)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log</span>-&gt;disk_full_time = ngx_time();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">log</span>-&gt;file-&gt;fd == ngx_stderr)</span><br><span class="line">        &#123;</span><br><span class="line">            wrote_stderr = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    next:</span><br><span class="line">        <span class="built_in">log</span> = <span class="built_in">log</span>-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ngx_use_stderr || level &gt; NGX_LOG_WARN || wrote_stderr)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    msg -= (<span class="number">7</span> + err_levels[level].len + <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    (<span class="type">void</span>)ngx_sprintf(msg, <span class="string">&quot;nginx: [%V] &quot;</span>, &amp;err_levels[level]);</span><br><span class="line">    <span class="comment">// 将相应的参数日志信息输出到标准错误（stderr）</span></span><br><span class="line">    (<span class="type">void</span>)ngx_write_console(ngx_stderr, msg, p - msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 主要是为了处理编译器不支持可变参数宏的情况下普通日志及 debug 日志的输出</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !(NGX_HAVE_VARIADIC_MACROS)</span></span><br><span class="line"><span class="type">void</span> ngx_cdecl <span class="title function_">ngx_log_error</span><span class="params">(<span class="type">ngx_uint_t</span> level, <span class="type">ngx_log_t</span> *<span class="built_in">log</span>, <span class="type">ngx_err_t</span> err, <span class="type">const</span> <span class="type">char</span> *fmt, ...)</span></span><br><span class="line">&#123;</span><br><span class="line">    va_list args;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">log</span>-&gt;log_level &gt;= level)</span><br><span class="line">    &#123;</span><br><span class="line">        va_start(args, fmt);</span><br><span class="line">        ngx_log_error_core(level, <span class="built_in">log</span>, err, fmt, args);</span><br><span class="line">        va_end(args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> ngx_cdecl <span class="title function_">ngx_log_debug_core</span><span class="params">(<span class="type">ngx_log_t</span> *<span class="built_in">log</span>, <span class="type">ngx_err_t</span> err, <span class="type">const</span> <span class="type">char</span> *fmt, ...)</span></span><br><span class="line">&#123;</span><br><span class="line">    va_list args;</span><br><span class="line"></span><br><span class="line">    va_start(args, fmt);</span><br><span class="line">    ngx_log_error_core(NGX_LOG_DEBUG, <span class="built_in">log</span>, err, fmt, args);</span><br><span class="line">    va_end(args);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于输出 alert 级别的日志</span></span><br><span class="line"><span class="type">void</span> ngx_cdecl <span class="title function_">ngx_log_abort</span><span class="params">(<span class="type">ngx_err_t</span> err, <span class="type">const</span> <span class="type">char</span> *fmt, ...)</span></span><br><span class="line">&#123;</span><br><span class="line">    u_char *p;</span><br><span class="line">    va_list args;</span><br><span class="line">    u_char errstr[NGX_MAX_CONF_ERRSTR];</span><br><span class="line"></span><br><span class="line">    va_start(args, fmt);</span><br><span class="line">    p = ngx_vsnprintf(errstr, <span class="keyword">sizeof</span>(errstr) - <span class="number">1</span>, fmt, args);</span><br><span class="line">    va_end(args);</span><br><span class="line"></span><br><span class="line">    ngx_log_error(NGX_LOG_ALERT, ngx_cycle-&gt;<span class="built_in">log</span>, err, <span class="string">&quot;%*s&quot;</span>, p - errstr, errstr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将相应的日志输出到 stderr</span></span><br><span class="line"><span class="type">void</span> ngx_cdecl <span class="title function_">ngx_log_stderr</span><span class="params">(<span class="type">ngx_err_t</span> err, <span class="type">const</span> <span class="type">char</span> *fmt, ...)</span></span><br><span class="line">&#123;</span><br><span class="line">    u_char *p, *last;</span><br><span class="line">    va_list args;</span><br><span class="line">    u_char errstr[NGX_MAX_ERROR_STR];</span><br><span class="line"></span><br><span class="line">    last = errstr + NGX_MAX_ERROR_STR;</span><br><span class="line"></span><br><span class="line">    p = ngx_cpymem(errstr, <span class="string">&quot;nginx: &quot;</span>, <span class="number">7</span>);</span><br><span class="line"></span><br><span class="line">    va_start(args, fmt);</span><br><span class="line">    p = ngx_vslprintf(p, last, fmt, args);</span><br><span class="line">    va_end(args);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err)</span><br><span class="line">    &#123;</span><br><span class="line">        p = ngx_log_errno(p, last, err);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (p &gt; last - NGX_LINEFEED_SIZE)</span><br><span class="line">    &#123;</span><br><span class="line">        p = last - NGX_LINEFEED_SIZE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_linefeed(p);</span><br><span class="line"></span><br><span class="line">    (<span class="type">void</span>)ngx_write_console(ngx_stderr, errstr, p - errstr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将 ngx_err_t 类型的错误码格式化到 buf 中</span></span><br><span class="line">u_char * <span class="title function_">ngx_log_errno</span><span class="params">(u_char *buf, u_char *last, <span class="type">ngx_err_t</span> err)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (buf &gt; last - <span class="number">50</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* leave a space for an error code */</span></span><br><span class="line">        buf = last - <span class="number">50</span>;</span><br><span class="line">        *buf++ = <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">        *buf++ = <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">        *buf++ = <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> (NGX_WIN32)</span></span><br><span class="line">    buf = ngx_slprintf(buf, last, ((<span class="type">unsigned</span>)err &lt; <span class="number">0x80000000</span>) ? <span class="string">&quot; (%d: &quot;</span> : <span class="string">&quot; (%Xd: &quot;</span>, err);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    buf = ngx_slprintf(buf, last, <span class="string">&quot; (%d: &quot;</span>, err);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    buf = ngx_strerror(err, buf, last - buf);</span><br><span class="line">    <span class="keyword">if</span> (buf &lt; last)</span><br><span class="line">    &#123;</span><br><span class="line">        *buf++ = <span class="string">&#x27;)&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> buf;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">ngx_log_t</span> *</span><br><span class="line"><span class="title function_">ngx_log_init</span><span class="params">(u_char *prefix, u_char *error_log)</span></span><br><span class="line">&#123;</span><br><span class="line">    u_char *p, *name;</span><br><span class="line">    <span class="type">size_t</span> nlen, plen;</span><br><span class="line"></span><br><span class="line">    ngx_log.file = &amp;ngx_log_file;</span><br><span class="line">    ngx_log.log_level = NGX_LOG_NOTICE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (error_log == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        error_log = (u_char *)NGX_ERROR_LOG_PATH;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    name = error_log;</span><br><span class="line">    nlen = ngx_strlen(name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nlen == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ngx_log_file.fd = ngx_stderr;</span><br><span class="line">        <span class="keyword">return</span> &amp;ngx_log;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    p = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> (NGX_WIN32)</span></span><br><span class="line">    <span class="keyword">if</span> (name[<span class="number">1</span>] != <span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="keyword">if</span> (name[<span class="number">0</span>] != <span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">if</span> (prefix)</span><br><span class="line">        &#123;</span><br><span class="line">            plen = ngx_strlen(prefix);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> NGX_PREFIX</span></span><br><span class="line">            prefix = (u_char *)NGX_PREFIX;</span><br><span class="line">            plen = ngx_strlen(prefix);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">            plen = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (plen)</span><br><span class="line">        &#123;</span><br><span class="line">            name = <span class="built_in">malloc</span>(plen + nlen + <span class="number">2</span>);</span><br><span class="line">            <span class="keyword">if</span> (name == <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            p = ngx_cpymem(name, prefix, plen);</span><br><span class="line">            <span class="keyword">if</span> (!ngx_path_separator(*(p - <span class="number">1</span>)))</span><br><span class="line">            &#123;</span><br><span class="line">                *p++ = <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ngx_cpystrn(p, error_log, nlen + <span class="number">1</span>);</span><br><span class="line">            p = name;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_log_file.fd = ngx_open_file(name, NGX_FILE_APPEND, NGX_FILE_CREATE_OR_OPEN, NGX_FILE_DEFAULT_ACCESS);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_log_file.fd == NGX_INVALID_FILE)</span><br><span class="line">    &#123;</span><br><span class="line">        ngx_log_stderr(ngx_errno, <span class="string">&quot;[alert] could not open error log file: &quot;</span> ngx_open_file_n <span class="string">&quot; \&quot;%s\&quot; failed&quot;</span>, name);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> (NGX_WIN32)</span></span><br><span class="line">        ngx_event_log(ngx_errno, <span class="string">&quot;could not open error log file: &quot;</span> ngx_open_file_n <span class="string">&quot; \&quot;%s\&quot; failed&quot;</span>, name);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        ngx_log_file.fd = ngx_stderr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (p)</span><br><span class="line">    &#123;</span><br><span class="line">        ngx_free(p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &amp;ngx_log;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">ngx_int_t</span> <span class="title function_">ngx_log_open_default</span><span class="params">(<span class="type">ngx_cycle_t</span> *cycle)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">ngx_log_t</span> *<span class="built_in">log</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_log_get_file_log(&amp;cycle-&gt;new_log) != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cycle-&gt;new_log.log_level != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* there are some error logs, but no files */</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">log</span> = ngx_pcalloc(cycle-&gt;pool, <span class="keyword">sizeof</span>(<span class="type">ngx_log_t</span>));</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">log</span> == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* no error logs at all */</span></span><br><span class="line">        <span class="built_in">log</span> = &amp;cycle-&gt;new_log;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">log</span>-&gt;log_level = NGX_LOG_ERR;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">log</span>-&gt;file = ngx_conf_open_file(cycle, &amp;cycle-&gt;error_log);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">log</span>-&gt;file == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">log</span> != &amp;cycle-&gt;new_log)</span><br><span class="line">    &#123;</span><br><span class="line">        ngx_log_insert(&amp;cycle-&gt;new_log, <span class="built_in">log</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">ngx_int_t</span> <span class="title function_">ngx_log_redirect_stderr</span><span class="params">(<span class="type">ngx_cycle_t</span> *cycle)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">ngx_fd_t</span> fd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cycle-&gt;log_use_stderr)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* file log always exists when we are called */</span></span><br><span class="line">    fd = ngx_log_get_file_log(cycle-&gt;<span class="built_in">log</span>)-&gt;file-&gt;fd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fd != ngx_stderr)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (ngx_set_stderr(fd) == NGX_FILE_ERROR)</span><br><span class="line">        &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, cycle-&gt;<span class="built_in">log</span>, ngx_errno, ngx_set_stderr_n <span class="string">&quot; failed&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">ngx_log_t</span> *</span><br><span class="line"><span class="title function_">ngx_log_get_file_log</span><span class="params">(<span class="type">ngx_log_t</span> *head)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">ngx_log_t</span> *<span class="built_in">log</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">log</span> = head; <span class="built_in">log</span>; <span class="built_in">log</span> = <span class="built_in">log</span>-&gt;next)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">log</span>-&gt;file != <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">log</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> *</span><br><span class="line"><span class="title function_">ngx_log_set_levels</span><span class="params">(<span class="type">ngx_conf_t</span> *cf, <span class="type">ngx_log_t</span> *<span class="built_in">log</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">ngx_uint_t</span> i, n, d, found;</span><br><span class="line">    <span class="type">ngx_str_t</span> *value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cf-&gt;args-&gt;nelts == <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log</span>-&gt;log_level = NGX_LOG_ERR;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    value = cf-&gt;args-&gt;elts;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">2</span>; i &lt; cf-&gt;args-&gt;nelts; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        found = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (n = <span class="number">1</span>; n &lt;= NGX_LOG_DEBUG; n++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (ngx_strcmp(value[i].data, err_levels[n].data) == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">log</span>-&gt;log_level != <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>, <span class="string">&quot;duplicate log level \&quot;%V\&quot;&quot;</span>, &amp;value[i]);</span><br><span class="line">                    <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">log</span>-&gt;log_level = n;</span><br><span class="line">                found = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (n = <span class="number">0</span>, d = NGX_LOG_DEBUG_FIRST; d &lt;= NGX_LOG_DEBUG_LAST; d &lt;&lt;= <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (ngx_strcmp(value[i].data, debug_levels[n++]) == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">log</span>-&gt;log_level &amp; ~NGX_LOG_DEBUG_ALL)</span><br><span class="line">                &#123;</span><br><span class="line">                    ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>, <span class="string">&quot;invalid log level \&quot;%V\&quot;&quot;</span>, &amp;value[i]);</span><br><span class="line">                    <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">log</span>-&gt;log_level |= d;</span><br><span class="line">                found = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!found)</span><br><span class="line">        &#123;</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>, <span class="string">&quot;invalid log level \&quot;%V\&quot;&quot;</span>, &amp;value[i]);</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">log</span>-&gt;log_level == NGX_LOG_DEBUG)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log</span>-&gt;log_level = NGX_LOG_DEBUG_ALL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> *</span><br><span class="line"><span class="title function_">ngx_error_log</span><span class="params">(<span class="type">ngx_conf_t</span> *cf, <span class="type">ngx_command_t</span> *cmd, <span class="type">void</span> *conf)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">ngx_log_t</span> *dummy;</span><br><span class="line"></span><br><span class="line">    dummy = &amp;cf-&gt;cycle-&gt;new_log;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ngx_log_set_log(cf, &amp;dummy);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> *</span><br><span class="line"><span class="title function_">ngx_log_set_log</span><span class="params">(<span class="type">ngx_conf_t</span> *cf, <span class="type">ngx_log_t</span> **head)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">ngx_log_t</span> *new_log;</span><br><span class="line">    <span class="type">ngx_str_t</span> *value, name;</span><br><span class="line">    <span class="type">ngx_syslog_peer_t</span> *peer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (*head != <span class="literal">NULL</span> &amp;&amp; (*head)-&gt;log_level == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        new_log = *head;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        new_log = ngx_pcalloc(cf-&gt;pool, <span class="keyword">sizeof</span>(<span class="type">ngx_log_t</span>));</span><br><span class="line">        <span class="keyword">if</span> (new_log == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (*head == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            *head = new_log;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    value = cf-&gt;args-&gt;elts;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_strcmp(value[<span class="number">1</span>].data, <span class="string">&quot;stderr&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ngx_str_null(&amp;name);</span><br><span class="line">        cf-&gt;cycle-&gt;log_use_stderr = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        new_log-&gt;file = ngx_conf_open_file(cf-&gt;cycle, &amp;name);</span><br><span class="line">        <span class="keyword">if</span> (new_log-&gt;file == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (ngx_strncmp(value[<span class="number">1</span>].data, <span class="string">&quot;memory:&quot;</span>, <span class="number">7</span>) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> (NGX_DEBUG)</span></span><br><span class="line">        <span class="type">size_t</span> size, needed;</span><br><span class="line">        <span class="type">ngx_pool_cleanup_t</span> *cln;</span><br><span class="line">        <span class="type">ngx_log_memory_buf_t</span> *buf;</span><br><span class="line"></span><br><span class="line">        value[<span class="number">1</span>].len -= <span class="number">7</span>;</span><br><span class="line">        value[<span class="number">1</span>].data += <span class="number">7</span>;</span><br><span class="line"></span><br><span class="line">        needed = <span class="keyword">sizeof</span>(<span class="string">&quot;MEMLOG  :&quot;</span> NGX_LINEFEED) + cf-&gt;conf_file-&gt;file.name.len + NGX_SIZE_T_LEN + NGX_INT_T_LEN + NGX_MAX_ERROR_STR;</span><br><span class="line"></span><br><span class="line">        size = ngx_parse_size(&amp;value[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (size == (<span class="type">size_t</span>)NGX_ERROR || size &lt; needed)</span><br><span class="line">        &#123;</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>, <span class="string">&quot;invalid buffer size \&quot;%V\&quot;&quot;</span>, &amp;value[<span class="number">1</span>]);</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        buf = ngx_pcalloc(cf-&gt;pool, <span class="keyword">sizeof</span>(<span class="type">ngx_log_memory_buf_t</span>));</span><br><span class="line">        <span class="keyword">if</span> (buf == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        buf-&gt;start = ngx_pnalloc(cf-&gt;pool, size);</span><br><span class="line">        <span class="keyword">if</span> (buf-&gt;start == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        buf-&gt;end = buf-&gt;start + size;</span><br><span class="line"></span><br><span class="line">        buf-&gt;pos = ngx_slprintf(buf-&gt;start, buf-&gt;end, <span class="string">&quot;MEMLOG %uz %V:%ui%N&quot;</span>, size, &amp;cf-&gt;conf_file-&gt;file.name, cf-&gt;conf_file-&gt;line);</span><br><span class="line"></span><br><span class="line">        ngx_memset(buf-&gt;pos, <span class="string">&#x27; &#x27;</span>, buf-&gt;end - buf-&gt;pos);</span><br><span class="line"></span><br><span class="line">        cln = ngx_pool_cleanup_add(cf-&gt;pool, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (cln == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cln-&gt;data = new_log;</span><br><span class="line">        cln-&gt;handler = ngx_log_memory_cleanup;</span><br><span class="line"></span><br><span class="line">        new_log-&gt;writer = ngx_log_memory_writer;</span><br><span class="line">        new_log-&gt;wdata = buf;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>, <span class="string">&quot;nginx was built without debug support&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (ngx_strncmp(value[<span class="number">1</span>].data, <span class="string">&quot;syslog:&quot;</span>, <span class="number">7</span>) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        peer = ngx_pcalloc(cf-&gt;pool, <span class="keyword">sizeof</span>(<span class="type">ngx_syslog_peer_t</span>));</span><br><span class="line">        <span class="keyword">if</span> (peer == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_syslog_process_conf(cf, peer) != NGX_CONF_OK)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        new_log-&gt;writer = ngx_syslog_writer;</span><br><span class="line">        new_log-&gt;wdata = peer;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        new_log-&gt;file = ngx_conf_open_file(cf-&gt;cycle, &amp;value[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">if</span> (new_log-&gt;file == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_log_set_levels(cf, new_log) != NGX_CONF_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (*head != new_log)</span><br><span class="line">    &#123;</span><br><span class="line">        ngx_log_insert(*head, new_log);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ngx_log_insert</span><span class="params">(<span class="type">ngx_log_t</span> *<span class="built_in">log</span>, <span class="type">ngx_log_t</span> *new_log)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">ngx_log_t</span> tmp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (new_log-&gt;log_level &gt; <span class="built_in">log</span>-&gt;log_level)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * list head address is permanent, insert new log after</span></span><br><span class="line"><span class="comment">         * head and swap its contents with head</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        tmp = *<span class="built_in">log</span>;</span><br><span class="line">        *<span class="built_in">log</span> = *new_log;</span><br><span class="line">        *new_log = tmp;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">log</span>-&gt;next = new_log;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">log</span>-&gt;next)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (new_log-&gt;log_level &gt; <span class="built_in">log</span>-&gt;next-&gt;log_level)</span><br><span class="line">        &#123;</span><br><span class="line">            new_log-&gt;next = <span class="built_in">log</span>-&gt;next;</span><br><span class="line">            <span class="built_in">log</span>-&gt;next = new_log;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">log</span> = <span class="built_in">log</span>-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">log</span>-&gt;next = new_log;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> (NGX_DEBUG)</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ngx_log_memory_writer</span><span class="params">(<span class="type">ngx_log_t</span> *<span class="built_in">log</span>, <span class="type">ngx_uint_t</span> level, u_char *buf, <span class="type">size_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">    u_char *p;</span><br><span class="line">    <span class="type">size_t</span> avail, written;</span><br><span class="line">    <span class="type">ngx_log_memory_buf_t</span> *mem;</span><br><span class="line"></span><br><span class="line">    mem = <span class="built_in">log</span>-&gt;wdata;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mem == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    written = ngx_atomic_fetch_add(&amp;mem-&gt;written, len);</span><br><span class="line"></span><br><span class="line">    p = mem-&gt;pos + written % (mem-&gt;end - mem-&gt;pos);</span><br><span class="line"></span><br><span class="line">    avail = mem-&gt;end - p;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (avail &gt;= len)</span><br><span class="line">    &#123;</span><br><span class="line">        ngx_memcpy(p, buf, len);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        ngx_memcpy(p, buf, avail);</span><br><span class="line">        ngx_memcpy(mem-&gt;pos, buf + avail, len - avail);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ngx_log_memory_cleanup</span><span class="params">(<span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">ngx_log_t</span> *<span class="built_in">log</span> = data;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug0(NGX_LOG_DEBUG_CORE, <span class="built_in">log</span>, <span class="number">0</span>, <span class="string">&quot;destroy memory log buffer&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">log</span>-&gt;wdata = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>




<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/447972882">在 Ubuntu 上使用源码安装 OpenResty</a></li>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1721171">详解linux下查看系统版本号信息的方法（总结）</a></li>
<li><a target="_blank" rel="noopener" href="https://openresty.org/cn/">openresty</a></li>
<li><a target="_blank" rel="noopener" href="https://luajit.org/">luajit</a></li>
<li><a target="_blank" rel="noopener" href="http://labs.frickle.com/nginx_ngx_cache_purge/">ngx_cache_purge</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/yaoweibin/nginx_upstream_check_module">nginx_upstream_check_module</a></li>
<li><a target="_blank" rel="noopener" href="https://ivanzz1001.github.io/records/post/nginx/2018/05/08/nginx-source_part43_1">core&#x2F;ngx_log.h 头文件分析</a></li>
<li><a target="_blank" rel="noopener" href="https://ivanzz1001.github.io/records/post/nginx/2018/05/08/nginx-source_part43_2">core&#x2F;ngx_log.c源文件分析</a></li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2024/02/19/Docker/" rel="prev" title="Docker">
      <i class="fa fa-chevron-left"></i> Docker
    </a></div>
      <div class="post-nav-item">
    <a href="/2024/02/19/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/" rel="next" title="编程思想">
      编程思想 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E8%A3%85"><span class="nav-number">1.</span> <span class="nav-text">安装</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%AE%89%E8%A3%85"><span class="nav-number">1.1.</span> <span class="nav-text">源码安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E5%8C%85"><span class="nav-number">1.2.</span> <span class="nav-text">相关包</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ngx-log"><span class="nav-number">1.3.</span> <span class="nav-text">Ngx.log</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#core-ngx-log-h-%E5%A4%B4%E6%96%87%E4%BB%B6%E5%88%86%E6%9E%90"><span class="nav-number">2.</span> <span class="nav-text">core&#x2F;ngx_log.h 头文件分析</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#core-ngx-log-c-%E6%BA%90%E6%96%87%E4%BB%B6%E5%88%86%E6%9E%90"><span class="nav-number">3.</span> <span class="nav-text">core&#x2F;ngx_log.c 源文件分析</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">4.</span> <span class="nav-text">参考</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Bling"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Bling</p>
  <div class="site-description" itemprop="description">绳锯木断，水滴石穿</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">29</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2023-01 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Bling</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

</body>
</html>
